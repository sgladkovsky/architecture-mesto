# Architecture mesto. Sprint #2

Документация перенесена в каталог docs

Новые файлы сборки находятся в каталоге steps в подкаталогах arch-mesto-X
Где X - номер сборки

История схемы в drawio помещена в docs/mesto-X.drawio

## Содержимое
api_app\ - Приложение pymongo_api
docs\ - документация и схемы drawio
steps\arch-mesto-1-sharding\ - Добавление шардирования
steps\arch-mesto-2-replication\ - Добавление репликации
steps\arch-mesto-3-cache\ - Добавление кэширования Redis

### Как установить
Перейти в каталог steps\arch-mesto-3-cache\ и запустить разворачивание сервисов docker-compose

```shell
cd steps\arch-mesto-3-cache\
docker compose up -d
```

После разворачивания сервисов необходимо настроить шардирование, репликацию и кэширование
```shell
bash ./scripts/init.sh
```
*Скрипт запускается из-под каталога steps\arch-mesto-3-cache\

### Проверки
#### Проверка шардирования и репликации
После настройки БД, необходимо проверить корректность работы репликации и шардирования
```shell
bash ./scripts/check.sh
```
В консоли выдаст количество документов в шардах и в репликах.
В каждой реплике количество должно совпадать с количеством в шарде.
При этом суммарно количество документов во всех шардах должно быть 1000

#### Проверка кэширования
Выполнить запрос для получения количества записей в коллекции helloDoc/users (кэшируемый запрос)
Для этого надо выполнить скрипт checkCache
```shell
bash ./scripts/checkCache.sh
```

В консоли выдаст время исполнения curl для вызова сервиса helloDoc/users. 
В первом вызове кэширования не было, поэтому должно быть долго, во втором данные будут закэшированы, поэтому надо проверить, что вызов был не более 100мс.


## Схемы сервисов
Схемы по заданиям
[Задание 1 -4](docs/mesto-1-4.drawio)

[Задание 5](docs/mesto-5.drawio)

[Задание 6](docs/mesto-6.drawio)

